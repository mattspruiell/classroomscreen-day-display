<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Admin</title>
    <style>
        :root {
            --primary: #007aff;
            --bg: #f2f2f7;
            --card-bg: #fff;
            --text: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #666;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 15px;
        }

        button {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        button:disabled {
            background: #ccc;
        }

        button.secondary {
            background: #e5e5ea;
            color: #333;
        }

        button.danger {
            background: #ff3b30;
            color: white;
        }

        button.small {
            padding: 8px 12px;
            font-size: 0.9rem;
            width: auto;
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab {
            padding: 10px 20px;
            background: #e5e5ea;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .preset-item {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preset-item:hover {
            background: #fafafa;
        }

        .row {
            display: flex;
            gap: 10px;
        }

        .col {
            flex: 1;
        }

        /* Calendar Grid */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .cal-day {
            background: white;
            border-radius: 6px;
            padding: 5px;
            min-height: 80px;
            position: relative;
            cursor: pointer;
            border: 1px solid #eee;
        }

        .cal-day:hover {
            border-color: var(--primary);
        }

        .cal-day.today {
            background: #eef7ff;
            font-weight: bold;
        }

        .cal-num {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
            text-align: right;
        }

        .cal-event {
            font-size: 0.75rem;
            padding: 4px;
            border-radius: 4px;
            color: white;
            background: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cal-default {
            background: #e5e5ea;
            color: #333;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <h1>Day Display Admin</h1>

    <div id="auth-section" class="card">
        <label>GitHub Personal Access Token</label>
        <input type="password" id="gh-token" placeholder="ghp_..." autocomplete="current-password">
        <button onclick="saveToken()">Login</button>
        <p style="font-size: 0.8rem; color: #888; margin-top: 10px;">Token is saved securely on your device.</p>
    </div>

    <div id="app-section" class="hidden">
        <div class="tabs">
            <div class="tab" id="btn-tab-calendar" onclick="switchTab('tab-calendar', this)">Calendar</div>
            <div class="tab" id="btn-tab-presets" onclick="switchTab('tab-presets', this)">Presets</div>
            <div class="tab" id="btn-tab-styles" onclick="switchTab('tab-styles', this)">Style Presets</div>
            <div class="tab" id="btn-tab-defaults" onclick="switchTab('tab-defaults', this)">Weekly Defaults</div>
        </div>

        <!-- CALENDAR TAB -->
        <div id="tab-calendar" class="hidden">
            <div class="card">
                <div class="calendar-header">
                    <button class="small secondary" onclick="changeMonth(-1)">Previous</button>
                    <h3 id="cal-month-title" style="margin:0;">December 2025</h3>
                    <button class="small secondary" onclick="changeMonth(1)">Next</button>
                </div>
                <div style="margin-bottom: 10px; text-align: right;">
                    <label style="display:inline-flex; align-items:center; cursor:pointer;"><input type="checkbox"
                            id="chk-hide-weekends" onchange="toggleHideWeekends()"
                            style="width:auto; margin:0 5px 0 0;"> Hide Weekends</label>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </div>

        <!-- PRESETS TAB -->
        <div id="tab-presets" class="hidden">
            <div class="card">
                <h3>Manage Presets</h3>
                <div id="presets-list"></div>
                <button onclick="createNewPreset()" class="secondary" style="margin-top: 10px;">+ Create New
                    Preset</button>
            </div>
        </div>

        <!-- STYLES TAB -->
        <div id="tab-styles" class="hidden">
            <div class="card">
                <h3>Style Presets</h3>
                <div id="styles-list"></div>
                <button onclick="createNewStyle()" class="secondary" style="margin-top: 10px;">+ Create New
                    Style</button>
            </div>
        </div>

        <!-- DEFAULTS TAB -->
        <div id="tab-defaults" class="hidden">
            <div class="card">
                <h3>Standard Weekly Schedule</h3>
                <div id="defaults-list"></div>
            </div>
        </div>

        <button onclick="pushToGitHub()" id="save-btn" style="margin-top: 20px;">Push Changes to Live Site</button>
        <div id="status"></div>
        <button onclick="logout()"
            style="background: transparent; color: #ff3b30; margin-top: 20px; font-size: 0.9rem;">Logout</button>
    </div>

    <!-- MODAL: ADD EVENT -->
    <div id="event-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3 id="modal-title">Schedule for [Date]</h3>
            <input type="hidden" id="modal-date">

            <label>Action</label>
            <select id="modal-action" onchange="toggleModalFields()">
                <option value="preset">Use Existing Preset</option>
                <option value="adhoc">Create Custom (Ad-hoc)</option>
                <option value="clear">Clear Schedule</option>
            </select>

            <div id="field-preset">
                <label>Select Preset</label>
                <select id="modal-preset-select"></select>
                <label style="margin-top:10px; font-size:0.85rem; color:#666;">Override Style (Optional)</label>
                <select id="modal-style-override">
                    <option value="">-- No Override --</option>
                </select>
            </div>

            <div id="field-adhoc" class="hidden">
                <label>Message</label>
                <input type="text" id="modal-adhoc-msg">
                <label>Subtext</label>
                <input type="text" id="modal-adhoc-sub">
                <label>Style</label>
                <select id="modal-style-select"></select>
            </div>

            <div id="recurrence-section" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
                <label>Recurrence</label>
                <div class="row">
                    <div class="col">
                        <select id="modal-recur" onchange="toggleRecurFields()">
                            <option value="none">Just this day</option>
                            <option value="weekly">Weekly</option>
                            <option value="ndays">Every N Days</option>
                        </select>
                    </div>
                    <div class="col hidden" id="field-recur-count">
                        <input type="number" id="modal-recur-count" value="1" min="1" placeholder="Days">
                    </div>
                </div>

                <div id="field-until" class="hidden">
                    <label>Repeat Until</label>
                    <input type="date" id="modal-until">
                </div>
            </div>

            <div class="row" style="margin-top: 20px;">
                <button onclick="saveEvent()" class="col">Save</button>
                <button onclick="closeModal('event-modal')" class="col secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PRESET EDITOR -->
    <div id="preset-editor-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>Edit Preset</h3>
            <input type="hidden" id="edit-preset-id">
            <label>Name</label> <input type="text" id="edit-p-name">
            <label>Message</label> <input type="text" id="edit-p-msg">
            <label>Subtext</label> <input type="text" id="edit-p-sub">
            <label>Apply Style (Optional)</label>
            <select id="edit-p-style" onchange="applyStyleToEditor(this.value)">
                <option value="">-- Select --</option>
            </select>

            <details>
                <summary style="margin:10px 0; cursor:pointer;">Advanced Color Overrides</summary>
                <div class="row">
                    <div class="col"><label>Text</label><input type="color" id="edit-p-text"></div>
                    <div class="col"><label>BG</label><input type="color" id="edit-p-bg"></div>
                </div>
                <div class="row">
                    <div class="col"><label>G-Start</label><input type="color" id="edit-p-gs"></div>
                    <div class="col"><label>G-End</label><input type="color" id="edit-p-ge"></div>
                </div>
            </details>

            <div class="row">
                <button onclick="savePreset()" class="col">Save</button>
                <button onclick="closeModal('preset-editor-modal')" class="col secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- STYLE EDITOR -->
    <div id="style-editor-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>Edit Style</h3>
            <input type="hidden" id="edit-style-id">
            <label>Name</label> <input type="text" id="edit-s-name">
            <div class="row">
                <div class="col"><label>Text</label><input type="color" id="edit-s-text"></div>
                <div class="col"><label>BG</label><input type="color" id="edit-s-bg"></div>
            </div>
            <div class="row">
                <div class="col"><label>G-Start</label><input type="color" id="edit-s-gs"></div>
                <div class="col"><label>G-End</label><input type="color" id="edit-s-ge"></div>
            </div>
            <div class="row">
                <button onclick="saveStyle()" class="col">Save</button>
                <button onclick="closeModal('style-editor-modal')" class="col secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const REPO_OWNER = 'mattspruiell';
        const REPO_NAME = 'classroomscreen-day-display';
        const CONFIG_PATH = 'config.json';

        // Defaults
        let currentState = { presets: {}, defaults: {}, calendar: {}, style_presets: {}, settings: { hideWeekends: true } };
        let currentSha = null;
        let visibleMonth = new Date();

        // INIT
        function loadToken() { const t = localStorage.getItem('gh_token'); if (t) { document.getElementById('gh-token').value = t; showApp(); } }
        function saveToken() { localStorage.setItem('gh_token', document.getElementById('gh-token').value.trim()); showApp(); }
        function logout() { localStorage.removeItem('gh_token'); location.reload(); }

        async function showApp() {
            try {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                await loadConfig();
            } catch (e) { alert("Init Error: " + e.message); }
        }

        async function loadConfig() {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CONFIG_PATH}`, {
                    headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}` }
                });
                if (!response.ok) throw new Error(`${response.status}`);
                const data = await response.json();
                currentSha = data.sha;
                currentState = JSON.parse(atob(data.content));

                // MIGRATION / DEFAULTS
                if (!currentState.style_presets) currentState.style_presets = {};
                if (!currentState.settings) currentState.settings = { hideWeekends: true };

                // Update UI state
                document.getElementById('chk-hide-weekends').checked = currentState.settings.hideWeekends;

                renderAll();
            } catch (e) {
                console.error(e);
                if (e.message.includes('403') || e.message.includes('404')) alert('Access Error: ' + e.message);
                else alert("Load Config Failed: " + e.message);
            }
        }

        function switchTab(id, tabEl) {
            try {
                document.querySelectorAll('#app-section > div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                if (tabEl) { tabEl.classList.add('active'); }
                else { const autoTab = document.querySelector(`.tab[onclick*="'${id}'"]`); if (autoTab) autoTab.classList.add('active'); }
                if (id === 'tab-calendar') renderCalendarGrid();
            } catch (e) { alert('Tab Switch Error: ' + e.message); }
        }

        function renderAll() {
            try {
                renderPresetsList();
                renderStylesList();
                renderDefaultsList();
                renderCalendarGrid();
                updateDropdowns();
            } catch (e) { alert("Render Error: " + e.message); }
        }

        // --- CALENDAR LOGIC ---

        function toggleHideWeekends() {
            currentState.settings.hideWeekends = document.getElementById('chk-hide-weekends').checked;
            renderCalendarGrid();
        }

        function renderCalendarGrid() {
            try {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';

                const hideWeekends = currentState.settings.hideWeekends;
                grid.style.gridTemplateColumns = hideWeekends ? 'repeat(5, 1fr)' : 'repeat(7, 1fr)';

                const month = visibleMonth.getMonth();
                const year = visibleMonth.getFullYear();
                const firstDay = new Date(year, month, 1);
                // getDay(): 0=Sun, 1=Mon...
                const startingDay = firstDay.getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                document.getElementById('cal-month-title').textContent = visibleMonth.toLocaleString('default', { month: 'long', year: 'numeric' });

                // Add Empty Cells for spacing
                let empties = startingDay; // e.g. Wed=3. Need 3 empty slots (Sun,Mon,Tue).
                // If hiding weekends, we need to adjust calculating empty slots.
                // We map real days to visible column indices.
                // Columns: Mon(0), Tue(1), Wed(2), Thu(3), Fri(4).
                // If 1st is Wed(3), and we just want Mon, Tue empty?
                // Logic: Iterate 0 to startingDay-1. If "Day i" is hidden, don't add slot.
                for (let i = 0; i < startingDay; i++) {
                    if (hideWeekends && (i === 0 || i === 6)) continue; // 0=Sun, 6=Sat
                    grid.appendChild(createDayEl('', 'disabled'));
                }

                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, month, d);
                    const dayOfWeek = date.getDay(); // 0-6

                    if (hideWeekends && (dayOfWeek === 0 || dayOfWeek === 6)) continue;

                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const presetId = currentState.calendar[dateStr];

                    const el = createDayEl(d, '', () => openEventModal(dateStr));

                    if (presetId) {
                        const preset = currentState.presets[presetId];
                        if (preset) {
                            el.innerHTML += `<div class="cal-event" style="background:${preset.theme.gradientStart}">${preset.name}</div>`;
                        }
                    } else {
                        const dayName = date.toLocaleString('en-us', { weekday: 'long' });
                        const defPresetId = currentState.defaults[dayName];
                        if (defPresetId && currentState.presets[defPresetId]) {
                            el.innerHTML += `<div class="cal-event cal-default">${currentState.presets[defPresetId].name}</div>`;
                        }
                    }
                    grid.appendChild(el);
                }
            } catch (e) { alert("Cal Render Error: " + e.message); }
        }

        function createDayEl(num, className, onClick) {
            const d = document.createElement('div');
            d.className = `cal-day ${className}`;
            if (num) d.innerHTML = `<div class="cal-num">${num}</div>`;
            if (onClick) d.onclick = onClick;
            return d;
        }

        function changeMonth(delta) {
            visibleMonth.setMonth(visibleMonth.getMonth() + delta);
            renderCalendarGrid();
        }

        // --- MODAL LOGIC ---

        function openEventModal(dateStr) {
            try {
                document.getElementById('modal-title').textContent = `Schedule for ${dateStr}`;
                document.getElementById('modal-date').value = dateStr;
                document.getElementById('modal-action').value = 'preset';

                // Reset fields
                document.getElementById('modal-recur').value = 'none';
                document.getElementById('modal-recur-count').value = 1;
                document.getElementById('modal-style-override').value = '';

                toggleModalFields();
                toggleRecurFields();
                document.getElementById('event-modal').classList.remove('hidden');
            } catch (e) { alert("Open Modal Error: " + e.message); }
        }

        function toggleModalFields() {
            const action = document.getElementById('modal-action').value;
            document.getElementById('field-preset').className = (action === 'preset') ? '' : 'hidden';
            document.getElementById('field-adhoc').className = (action === 'adhoc') ? '' : 'hidden';
        }

        function toggleRecurFields() {
            const recur = document.getElementById('modal-recur').value;
            document.getElementById('field-until').className = (recur !== 'none') ? '' : 'hidden';
            // Show "Every N Days" count input?
            document.getElementById('field-recur-count').className = (recur === 'ndays') ? '' : 'hidden';
        }

        function addBusinessDays(date, days) {
            // Helper to add 'days' skipping Sat/Sun
            let d = new Date(date);
            let added = 0;
            while (added < days) {
                d.setDate(d.getDate() + 1);
                const day = d.getDay();
                if (day !== 0 && day !== 6) { // If not Sun or Sat
                    added++;
                }
            }
            return d;
        }

        function saveEvent() {
            try {
                const dateStr = document.getElementById('modal-date').value;
                const action = document.getElementById('modal-action').value;
                const recur = document.getElementById('modal-recur').value;
                const hideWeekends = currentState.settings.hideWeekends;

                let targetPresetId = null;

                if (action === 'clear') {
                    delete currentState.calendar[dateStr];
                    // Save Logic Below will handle recurrence clear potentially? 
                    // No, "Clear" usually applies to date range too.
                } else if (action === 'preset') {
                    const basePresetId = document.getElementById('modal-preset-select').value;
                    const overrideStyleId = document.getElementById('modal-style-override').value;

                    if (overrideStyleId) {
                        // Creates an "Ad-hoc" helper to apply style override
                        targetPresetId = 'evt_override_' + Date.now();
                        const base = currentState.presets[basePresetId];
                        const style = currentState.style_presets[overrideStyleId];

                        currentState.presets[targetPresetId] = {
                            name: base.name, // Keep name
                            type: 'adhoc',
                            message: base.message,
                            subtext: base.subtext || '',
                            theme: { ...style.theme } // Use new style
                        };
                    } else {
                        targetPresetId = basePresetId;
                    }
                } else if (action === 'adhoc') {
                    targetPresetId = 'evt_' + Date.now();
                    const styleId = document.getElementById('modal-style-select').value;
                    const style = currentState.style_presets[styleId] || { theme: { textColor: '#000', backgroundColor: '#fff' } };

                    currentState.presets[targetPresetId] = {
                        name: `Ad-hoc ${dateStr}`,
                        type: 'adhoc',
                        message: document.getElementById('modal-adhoc-msg').value,
                        subtext: document.getElementById('modal-adhoc-sub').value,
                        theme: { ...style.theme }
                    };
                }

                // Apply to Date(s)
                const datesToSet = [];
                // Always add the start date (even if "Clear", we might want to clear a range)
                // For "Clear", targetPresetId is null.

                // If clearing, we need to loop and 'delete'.
                // If setting, we loop and 'set'.

                const untilVal = document.getElementById('modal-until').value;
                let curr = new Date(dateStr);
                const limit = untilVal ? new Date(untilVal) : new Date(dateStr); // Default to single day range

                // Recur Step
                let step = 0;
                let stepMode = 'none'; // none, weekly, ndays

                if (recur === 'weekly') { stepMode = 'weekly'; }
                else if (recur === 'ndays') {
                    stepMode = 'ndays';
                    step = parseInt(document.getElementById('modal-recur-count').value) || 1;
                }

                // If no recurrence, loop runs once.
                // If recurrence, loop until limit.

                while (curr <= limit) {
                    const dStr = curr.toISOString().split('T')[0];
                    datesToSet.push(dStr);

                    if (stepMode === 'none') break; // Once

                    // Advance 'curr'
                    if (stepMode === 'weekly') {
                        curr.setDate(curr.getDate() + 7);
                    } else if (stepMode === 'ndays') {
                        if (hideWeekends) {
                            curr = addBusinessDays(curr, step);
                        } else {
                            curr.setDate(curr.getDate() + step);
                        }
                    }
                }

                datesToSet.forEach(d => {
                    if (action === 'clear') delete currentState.calendar[d];
                    else currentState.calendar[d] = targetPresetId;
                });

                closeModal('event-modal');
                renderAll();
            } catch (e) { alert("Save Event Error: " + e.message); }
        }


        function renderPresetsList() {
            const c = document.getElementById('presets-list'); c.innerHTML = '';
            Object.keys(currentState.presets).forEach(k => {
                const p = currentState.presets[k];
                if (p.type === 'adhoc') return;
                const d = document.createElement('div');
                d.className = 'preset-item';
                d.innerHTML = `<span><strong>${p.name}</strong> (${p.message})</span> <div><button class="small secondary" onclick="copyPreset('${k}')">Copy</button> <button class="small" onclick="editPreset('${k}')">Edit</button></div>`;
                c.appendChild(d);
            });
        }
        function renderStylesList() {
            const c = document.getElementById('styles-list'); c.innerHTML = '';
            Object.keys(currentState.style_presets).forEach(k => {
                const s = currentState.style_presets[k];
                const d = document.createElement('div');
                d.className = 'preset-item';
                d.innerHTML = `<span style="background:linear-gradient(to right, ${s.theme.gradientStart}, ${s.theme.gradientEnd}); -webkit-background-clip:text; color:transparent; font-weight:bold;">${s.name}</span> <button class="small" onclick="editStyle('${k}')">Edit</button>`;
                c.appendChild(d);
            });
        }
        function renderDefaultsList() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const c = document.getElementById('defaults-list'); c.innerHTML = '';
            days.forEach(day => {
                const sel = document.createElement('select');
                sel.innerHTML = '<option value="">None</option>';
                Object.keys(currentState.presets).forEach(k => {
                    if (currentState.presets[k].type !== 'adhoc')
                        sel.innerHTML += `<option value="${k}" ${currentState.defaults[day] === k ? 'selected' : ''}>${currentState.presets[k].name}</option>`;
                });
                sel.onchange = (e) => currentState.defaults[day] = e.target.value;
                const d = document.createElement('div'); d.innerHTML = `<label>${day}</label>`; d.appendChild(sel);
                c.appendChild(d);
            });
        }

        function editPreset(k) {
            try {
                const p = currentState.presets[k];
                document.getElementById('edit-preset-id').value = k;
                document.getElementById('edit-p-name').value = p.name;
                document.getElementById('edit-p-msg').value = p.message;
                document.getElementById('edit-p-sub').value = p.subtext || '';
                document.getElementById('edit-p-text').value = p.theme.textColor;
                document.getElementById('edit-p-bg').value = p.theme.backgroundColor;
                document.getElementById('edit-p-gs').value = p.theme.gradientStart;
                document.getElementById('edit-p-ge').value = p.theme.gradientEnd;
                document.getElementById('preset-editor-modal').classList.remove('hidden');
            } catch (e) { alert("Edit Preset Error: " + e.message); }
        }
        function savePreset() {
            try {
                const k = document.getElementById('edit-preset-id').value;
                currentState.presets[k] = {
                    name: document.getElementById('edit-p-name').value,
                    type: 'standard',
                    message: document.getElementById('edit-p-msg').value,
                    subtext: document.getElementById('edit-p-sub').value,
                    theme: {
                        textColor: document.getElementById('edit-p-text').value,
                        backgroundColor: document.getElementById('edit-p-bg').value,
                        gradientStart: document.getElementById('edit-p-gs').value,
                        gradientEnd: document.getElementById('edit-p-ge').value
                    }
                };
                closeModal('preset-editor-modal'); renderAll();
            } catch (e) { alert("Save Preset Error: " + e.message); }
        }
        function copyPreset(k) {
            try {
                const newId = 'preset_' + Date.now();
                currentState.presets[newId] = JSON.parse(JSON.stringify(currentState.presets[k]));
                currentState.presets[newId].name += " (Copy)";
                renderAll();
            } catch (e) { alert("Copy Error: " + e.message); }
        }
        function createNewPreset() {
            const id = 'preset_' + Date.now();
            currentState.presets[id] = { name: "New Preset", type: "standard", message: "X", theme: { textColor: "#000", backgroundColor: "#fff" } };
            editPreset(id);
        }

        function editStyle(k) {
            try {
                const s = currentState.style_presets[k];
                document.getElementById('edit-style-id').value = k;
                document.getElementById('edit-s-name').value = s.name;
                document.getElementById('edit-s-text').value = s.theme.textColor;
                document.getElementById('edit-s-bg').value = s.theme.backgroundColor;
                document.getElementById('edit-s-gs').value = s.theme.gradientStart;
                document.getElementById('edit-s-ge').value = s.theme.gradientEnd;
                document.getElementById('style-editor-modal').classList.remove('hidden');
            } catch (e) { alert("Edit Style Error: " + e.message); }
        }
        function saveStyle() {
            try {
                const k = document.getElementById('edit-style-id').value;
                currentState.style_presets[k] = {
                    name: document.getElementById('edit-s-name').value,
                    theme: {
                        textColor: document.getElementById('edit-s-text').value,
                        backgroundColor: document.getElementById('edit-s-bg').value,
                        gradientStart: document.getElementById('edit-s-gs').value,
                        gradientEnd: document.getElementById('edit-s-ge').value
                    }
                };
                closeModal('style-editor-modal');
                renderAll();
            } catch (e) { alert("Save Style Error: " + e.message); }
        }
        function createNewStyle() {
            const id = 'style_' + Date.now();
            currentState.style_presets[id] = { name: "New Style", theme: { textColor: "#000", backgroundColor: "#fff" } };
            editStyle(id);
        }
        function applyStyleToEditor(styleId) {
            if (!styleId) return;
            const s = currentState.style_presets[styleId];
            document.getElementById('edit-p-text').value = s.theme.textColor;
            document.getElementById('edit-p-bg').value = s.theme.backgroundColor;
            document.getElementById('edit-p-gs').value = s.theme.gradientStart;
            document.getElementById('edit-p-ge').value = s.theme.gradientEnd;
        }

        function updateDropdowns() {
            const styles = document.getElementById('modal-style-select');
            const styles2 = document.getElementById('edit-p-style');
            styles.innerHTML = ''; styles2.innerHTML = '<option value="">-- Apply Style --</option>';
            Object.keys(currentState.style_presets).forEach(k => {
                const opt = `<option value="${k}">${currentState.style_presets[k].name}</option>`;
                styles.innerHTML += opt; styles2.innerHTML += opt;
            });

            const presets = document.getElementById('modal-preset-select');
            presets.innerHTML = '';
            Object.keys(currentState.presets).forEach(k => {
                if (currentState.presets[k].type !== 'adhoc')
                    presets.innerHTML += `<option value="${k}">${currentState.presets[k].name}</option>`;
            });
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        async function pushToGitHub() {
            const btn = document.getElementById('save-btn'); btn.disabled = true;
            try {
                const content = btoa(JSON.stringify(currentState, null, 4));
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CONFIG_PATH}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'Update config via Admin Phase 4', content: content, sha: currentSha })
                });
                if (response.ok) {
                    const data = await response.json(); currentSha = data.content.sha;
                    alert('Saved Successfully!');
                } else {
                    alert('Save Failed: ' + response.statusText);
                }
            } catch (e) { alert('Push Error: ' + e.message); }
            btn.disabled = false;
        }

        switchTab('tab-calendar');
        loadToken();
    </script>
</body>

</html>